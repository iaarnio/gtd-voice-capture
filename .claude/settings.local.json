{
  "permissions": {
    "allow": [
      "Bash(npm install:*)",
      "Bash(npm run build:*)",
      "Bash(timeout 5 npm start:*)",
      "Bash(/tmp/test_server.sh << 'EOF'\n#!/bin/bash\ncd /Users/ilari/Projects/gtd-voice-capture\nnpm start > /tmp/server.log 2>&1 &\nPID=$!\nsleep 3\ncurl -s http://localhost:3000/health && echo \"\"\ncurl -s http://localhost:3000/ready && echo \"\"\nkill $PID 2>/dev/null || true\nsleep 1\necho \"=== Server Logs ===\"\ncat /tmp/server.log\nEOF)",
      "Bash(chmod:*)",
      "Bash(/tmp/test_server.sh:*)",
      "Bash(/tmp/test_config.sh << 'EOF'\n#!/bin/bash\ncd /Users/ilari/Projects/gtd-voice-capture\n# Clear required env vars\nunset OPENAI_API_KEY\nunset SMTP_HOST\nunset INGEST_TOKEN\nnpm start 2>&1 | head -50\nEOF)",
      "Bash(/tmp/test_config.sh)",
      "Bash(OPENAI_API_KEY='' SMTP_HOST='' INGEST_TOKEN='' npm start:*)",
      "Bash(git add:*)",
      "Bash(git commit -m \"$\\(cat <<''EOF''\nPhase 0: Scaffold & invariants\n\n- Initialize Node.js project with TypeScript\n- Set up Pino logger with structured JSON output\n- Implement config.ts with Zod validation\n- Add /health and /ready endpoints\n- Implement RequestId middleware for request correlation\n- Add graceful shutdown handlers\n- Create multi-stage ARM64 Dockerfile\n- Set up .env.example and .gitignore\n- All logs output as JSON for Loki/Grafana integration\n- Configuration validation logs fatal error on missing env vars\n\nAt the end of Phase 0:\n✓ Container starts cleanly\n✓ Logs appear as structured JSON to stdout\n✓ Readiness checks configuration\n✓ Request correlation working \\(X-Request-Id header\\)\n✓ Can already create Grafana panels from Loki logs\n\nCo-Authored-By: Claude Haiku 4.5 <noreply@anthropic.com>\nEOF\n\\)\")",
      "Bash(/tmp/test_phase1.sh << 'EOF'\n#!/bin/bash\ncd /Users/ilari/Projects/gtd-voice-capture\n\n# Start server in background\nnpm start > /tmp/phase1.log 2>&1 &\nPID=$!\nsleep 2\n\necho \"=== Test 1: POST /voice without auth header ===\"\ncurl -s -X POST http://localhost:3000/voice | jq .\n\necho \"\"\necho \"=== Test 2: POST /voice with invalid token ===\"\ncurl -s -X POST http://localhost:3000/voice \\\\\n  -H \"Authorization: Bearer wrong-token\" | jq .\n\necho \"\"\necho \"=== Test 3: POST /voice without file ===\"\ncurl -s -X POST http://localhost:3000/voice \\\\\n  -H \"Authorization: Bearer test-token-12345\" | jq .\n\necho \"\"\necho \"=== Test 4: POST /voice with audio file ===\"\n# Create a test audio file \\(minimal WAV\\)\necho \"RIFF\" > /tmp/test.wav\ncurl -s -X POST http://localhost:3000/voice \\\\\n  -H \"Authorization: Bearer test-token-12345\" \\\\\n  -F \"file=@/tmp/test.wav\" | jq .\n\necho \"\"\necho \"=== Server Logs \\(last 30 lines\\) ===\"\nsleep 1\nkill $PID 2>/dev/null || true\nsleep 1\ntail -30 /tmp/phase1.log\nEOF)",
      "Bash(/tmp/test_phase1.sh:*)",
      "Bash(/tmp/test_valid_audio.sh:*)",
      "Bash(/tmp/test_valid_audio.sh)",
      "Bash(/tmp/test_valid_audio2.sh << 'EOF'\n#!/bin/bash\ncd /Users/ilari/Projects/gtd-voice-capture\n\n# Create a minimal valid WAV file\npython3 << 'PYTHON'\nimport wave\nimport struct\n\nwith wave.open\\('/tmp/test_audio.wav', 'wb'\\) as wav_file:\n    wav_file.setnchannels\\(1\\)\n    wav_file.setsampwidth\\(2\\)\n    wav_file.setframerate\\(16000\\)\n    silence = struct.pack\\('<h', 0\\) * 16000\n    wav_file.writeframes\\(silence\\)\nPYTHON\n\n# Start server\nnpm start > /tmp/test_valid2.log 2>&1 &\nPID=$!\nsleep 2\n\necho \"=== Test with valid WAV file \\(explicit MIME type\\) ===\"\ncurl -s -X POST http://localhost:3000/voice \\\\\n  -H \"Authorization: Bearer test-token-12345\" \\\\\n  -F \"file=@/tmp/test_audio.wav;type=audio/wav\" | jq .\n\necho \"\"\necho \"=== Request details from logs ===\"\nsleep 1\nkill $PID 2>/dev/null || true\nsleep 1\ngrep '\"method\":\"POST\"' /tmp/test_valid2.log | jq '.req | {method, url, headers: .headers}'\nEOF)",
      "Bash(/tmp/test_valid_audio2.sh)",
      "Bash(/tmp/test_wrong_format.sh:*)",
      "Bash(/tmp/test_wrong_format.sh)",
      "Bash(/tmp/comprehensive_test.sh:*)",
      "Bash(/tmp/comprehensive_test.sh)",
      "Bash(/tmp/verify_logs.sh << 'EOF'\n#!/bin/bash\ncd /Users/ilari/Projects/gtd-voice-capture\n\n# Create a test audio file\npython3 << 'PYTHON'\nimport wave, struct\nwith wave.open\\('/tmp/test.wav', 'wb'\\) as w:\n    w.setnchannels\\(1\\)\n    w.setsampwidth\\(2\\)\n    w.setframerate\\(16000\\)\n    w.writeframes\\(struct.pack\\('<h', 0\\) * 16000\\)\nPYTHON\n\nnpm start > /tmp/verify.log 2>&1 &\nPID=$!\nsleep 2\n\n# Make a successful request\ncurl -s -X POST http://localhost:3000/voice \\\\\n  -H \"Authorization: Bearer test-token-12345\" \\\\\n  -F \"file=@/tmp/test.wav;type=audio/wav\" > /dev/null\n\nsleep 1\nkill $PID 2>/dev/null || true\nsleep 1\n\necho \"=== Full log for successful request \\(one request\\) ===\"\ntail -20 /tmp/verify.log | grep -E 'test.wav|Request|Service|listening' | head -15\nEOF)",
      "Bash(/tmp/verify_logs.sh:*)",
      "Bash(git commit:*)",
      "Bash(docker build:*)",
      "Bash(/tmp/test_docker.sh << 'SCRIPT'\n#!/bin/bash\ndocker run \\\\\n  --rm \\\\\n  -p 3001:3000 \\\\\n  -e NODE_ENV=production \\\\\n  -e PORT=3000 \\\\\n  -e SERVICE_VERSION=0.1.0-docker \\\\\n  -e INGEST_TOKEN=test-token-12345 \\\\\n  -e OPENAI_API_KEY=sk-test \\\\\n  -e SMTP_HOST=localhost \\\\\n  -e SMTP_PORT=587 \\\\\n  -e SMTP_USER=test@example.com \\\\\n  -e SMTP_PASS=testpass \\\\\n  -e MAIL_FROM=gtd@example.com \\\\\n  -e MAIL_TO=inbox@example.com \\\\\n  gtd-voice-capture:latest > /tmp/docker_run.log 2>&1 &\n\nCONTAINER_PID=$!\nsleep 3\n\necho \"=== Testing Docker Container ===\"\necho \"\"\necho \"Test 1: Health endpoint\"\ncurl -s http://localhost:3001/health | jq .\n\necho \"\"\necho \"Test 2: Ready endpoint\"\ncurl -s http://localhost:3001/ready | jq .\n\necho \"\"\necho \"=== Container Startup Logs ===\"\ncat /tmp/docker_run.log | head -10\n\necho \"\"\necho \"Killing container...\"\nkill $CONTAINER_PID 2>/dev/null || true\nsleep 2\nSCRIPT)",
      "Bash(/tmp/test_docker.sh)",
      "Bash(/tmp/test_whisper.sh << 'EOF'\n#!/bin/bash\ncd /Users/ilari/Projects/gtd-voice-capture\n\n# Create a test audio file\npython3 << 'PYTHON'\nimport wave, struct\nwith wave.open\\('/tmp/test.wav', 'wb'\\) as w:\n    w.setnchannels\\(1\\)\n    w.setsampwidth\\(2\\)\n    w.setframerate\\(16000\\)\n    w.writeframes\\(struct.pack\\('<h', 0\\) * 16000\\)\nPYTHON\n\n# Start server with invalid API key to test error handling\nOPENAI_API_KEY=\"sk-invalid-test-key\" npm start > /tmp/whisper_test.log 2>&1 &\nPID=$!\nsleep 2\n\necho \"=== Testing Whisper Error Handling \\(with invalid API key\\) ===\"\necho \"\"\necho \"POST /voice with valid audio file \\(but bad API key\\):\"\ncurl -s -X POST http://localhost:3000/voice \\\\\n  -H \"Authorization: Bearer test-token-12345\" \\\\\n  -F \"file=@/tmp/test.wav;type=audio/wav\" | jq .\n\necho \"\"\necho \"=== Relevant logs \\(Whisper error handling\\) ===\"\nsleep 2\nkill $PID 2>/dev/null || true\nsleep 1\n\n# Extract the error logs\ngrep -E 'component\":\"whisper' /tmp/whisper_test.log | jq -c '{msg, component, error: .error, duration: .duration}' | head -5\nEOF)",
      "Bash(/tmp/test_whisper.sh)",
      "Bash(/tmp/test_whisper_logs.sh << 'EOF'\n#!/bin/bash\ncd /Users/ilari/Projects/gtd-voice-capture\n\n# Create test audio\npython3 << 'PYTHON'\nimport wave, struct\nwith wave.open\\('/tmp/test.wav', 'wb'\\) as w:\n    w.setnchannels\\(1\\)\n    w.setsampwidth\\(2\\)\n    w.setframerate\\(16000\\)\n    w.writeframes\\(struct.pack\\('<h', 0\\) * 16000\\)\nPYTHON\n\n# Test with invalid key\nOPENAI_API_KEY=\"sk-invalid-test-key\" npm start > /tmp/whisper_logs.log 2>&1 &\nPID=$!\nsleep 2\n\ncurl -s -X POST http://localhost:3000/voice \\\\\n  -H \"Authorization: Bearer test-token-12345\" \\\\\n  -F \"file=@/tmp/test.wav;type=audio/wav\" > /dev/null\n\nsleep 2\nkill $PID 2>/dev/null || true\nsleep 1\n\necho \"=== Full request lifecycle for failed Whisper call ===\"\ncat /tmp/whisper_logs.log | grep -v \"listening\\\\|starting\\\\|SIGTERM\" | jq -c '.' | head -20\nEOF)",
      "Bash(/tmp/test_whisper_logs.sh)",
      "Bash(/tmp/test_whisper_simple.sh << 'EOF'\n#!/bin/bash\ncd /Users/ilari/Projects/gtd-voice-capture\n\npython3 << 'PYTHON'\nimport wave, struct\nwith wave.open\\('/tmp/test.wav', 'wb'\\) as w:\n    w.setnchannels\\(1\\)\n    w.setsampwidth\\(2\\)\n    w.setframerate\\(16000\\)\n    w.writeframes\\(struct.pack\\('<h', 0\\) * 16000\\)\nPYTHON\n\nOPENAI_API_KEY=\"sk-invalid-test-key\" npm start > /tmp/simple_logs.log 2>&1 &\nPID=$!\nsleep 2\n\ncurl -s -X POST http://localhost:3000/voice \\\\\n  -H \"Authorization: Bearer test-token-12345\" \\\\\n  -F \"file=@/tmp/test.wav;type=audio/wav\" > /dev/null\n\nsleep 2\nkill $PID 2>/dev/null || true\nsleep 1\n\necho \"=== Request lifecycle logs \\(filtered\\) ===\"\ngrep -E 'Request received|Request completed|Whisper|unauthorized' /tmp/simple_logs.log | tail -15\nEOF)",
      "Bash(/tmp/test_whisper_simple.sh)",
      "Bash(/tmp/test_phase2_comprehensive.sh:*)",
      "Bash(/tmp/test_phase2_comprehensive.sh)",
      "Bash(/tmp/quick_whisper_test.sh << 'EOF'\n#!/bin/bash\ncd /Users/ilari/Projects/gtd-voice-capture\n\n# Create test WAV\npython3 << 'PYTHON'\nimport wave, struct\nwith wave.open\\('/tmp/test.wav', 'wb'\\) as w:\n    w.setnchannels\\(1\\)\n    w.setsampwidth\\(2\\)\n    w.setframerate\\(16000\\)\n    # 1 second of silence \\(16000 samples\\)\n    w.writeframes\\(struct.pack\\('<h', 0\\) * 16000\\)\nPYTHON\n\n# Use the real API key from .env\nnpm start > /tmp/real_api.log 2>&1 &\nPID=$!\nsleep 2\n\necho \"Testing with real OpenAI API...\"\ncurl -s -X POST http://localhost:3000/voice \\\\\n  -H \"Authorization: Bearer test-token-12345\" \\\\\n  -F \"file=@/tmp/test.wav;type=audio/wav\"\n\nsleep 2\nkill $PID 2>/dev/null || true\nsleep 1\n\necho \"\"\necho \"\"\necho \"=== Logs from Whisper transcription ===\"\ngrep -E 'Calling Whisper|transcription successful|transcription failed' /tmp/real_api.log\nEOF)",
      "Bash(/tmp/quick_whisper_test.sh)",
      "Bash(/tmp/debug_whisper.sh << 'EOF'\n#!/bin/bash\ncd /Users/ilari/Projects/gtd-voice-capture\n\npython3 << 'PYTHON'\nimport wave, struct\nwith wave.open\\('/tmp/test.wav', 'wb'\\) as w:\n    w.setnchannels\\(1\\)\n    w.setsampwidth\\(2\\)\n    w.setframerate\\(16000\\)\n    w.writeframes\\(struct.pack\\('<h', 0\\) * 16000\\)\nPYTHON\n\nnpm start > /tmp/debug.log 2>&1 &\nPID=$!\nsleep 2\n\ncurl -s -X POST http://localhost:3000/voice \\\\\n  -H \"Authorization: Bearer test-token-12345\" \\\\\n  -F \"file=@/tmp/test.wav;type=audio/wav\" > /dev/null\n\nsleep 2\nkill $PID 2>/dev/null || true\nsleep 1\n\necho \"=== Full error log ===\"\ngrep \"OpenAI API error\" /tmp/debug.log | jq '.'\nEOF)",
      "Bash(/tmp/debug_whisper.sh)"
    ]
  }
}
